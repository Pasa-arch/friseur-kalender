<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Friseur Kalender</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial, sans-serif; margin: 30px; }
input, select, button { margin: 4px; padding: 6px; }

table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }

.overlap { background: #ffd0d0; }
</style>
</head>

<body>

<h1>Gemeinsamer Friseur-Kalender</h1>

<form id="eventForm">
  <select id="staff" required>
    <option value="">Mitarbeiter</option>
    <option>Soner</option>
    <option>G√ºlcin</option>
    <option>Kadir</option>
    <option>Herrmann</option>
  </select>

  <input id="customer" placeholder="Kunde">
  <input id="title" placeholder="Leistung" required>

  <input type="datetime-local" id="start" required>
  <input type="datetime-local" id="end" required>

  <button type="submit">Speichern</button>
</form>

<hr>

<div>
  <button id="prevDay">‚óÄ</button>
  <strong id="dayLabel"></strong>
  <button id="nextDay">‚ñ∂</button>
</div>

<table>
<thead>
<tr>
  <th>Mitarbeiter</th>
  <th>Kunde</th>
  <th>Leistung</th>
  <th>Start</th>
  <th>Ende</th>
  <th>Aktion</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://vsswsckjvfeglbtealdg.supabase.co",
  "sb_publishable_dwQCSJ-LalgHObHxubryEA_7DNYOqcP"
);

/* ================= STATE ================= */
const list = document.getElementById("list");
let editId = null;

/* ================= TAG ================= */
let currentDay = new Date();
currentDay.setHours(0,0,0,0);

const dayLabel = document.getElementById("dayLabel");

function updateDayLabel() {
  dayLabel.textContent = currentDay.toLocaleDateString("de-DE", {
    weekday: "long",
    day: "2-digit",
    month: "2-digit",
    year: "numeric"
  });
}

document.getElementById("prevDay").onclick = () => {
  currentDay.setDate(currentDay.getDate() - 1);
  updateDayLabel();
  loadEvents();
};

document.getElementById("nextDay").onclick = () => {
  currentDay.setDate(currentDay.getDate() + 1);
  updateDayLabel();
  loadEvents();
};

updateDayLabel();

/* ================= LADEN ================= */
async function loadEvents() {
  const start = new Date(currentDay);
  const end = new Date(currentDay);
  end.setHours(23,59,59,999);

  const { data, error } = await sb
    .from("events")
    .select("*")
    .gte("start_time", start.toISOString())
    .lte("start_time", end.toISOString())
    .order("start_time");

  if (error) {
    alert(error.message);
    return;
  }

  renderTable(data);
}

/* ================= TABELLE ================= */
function renderTable(data) {
  list.innerHTML = "";

  data.forEach(e => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${e.staff}</td>
      <td>${e.customer || "-"}</td>
      <td>${e.title}</td>
      <td>${new Date(e.start_time).toLocaleTimeString("de-DE", {hour:"2-digit",minute:"2-digit"})}</td>
      <td>${new Date(e.end_time).toLocaleTimeString("de-DE", {hour:"2-digit",minute:"2-digit"})}</td>
      <td>
        <button onclick="editEvent('${e.id}')">‚úèÔ∏è</button>
        <button onclick="deleteEvent('${e.id}')">üóë</button>
      </td>
    `;

    list.appendChild(tr);
  });
}

/* ================= FORM ================= */
document.getElementById("eventForm").onsubmit = async (e) => {
  e.preventDefault();

  const ev = {
    staff: staff.value,
    customer: customer.value || null,
    title: title.value,
    start_time: start.value.replace("T"," ") + ":00",
    end_time: end.value.replace("T"," ") + ":00"
  };

  const res = editId
    ? await sb.from("events").update(ev).eq("id", editId)
    : await sb.from("events").insert([ev]);

  if (res.error) {
    alert(res.error.message);
    return;
  }

  editId = null;
  e.target.reset();
  loadEvents();
};

/* ================= EDIT ================= */
window.editEvent = async (id) => {
  const { data, error } = await sb
    .from("events")
    .select("*")
    .eq("id", id)
    .single();

  if (error) {
    alert(error.message);
    return;
  }

  staff.value = data.staff;
  customer.value = data.customer || "";
  title.value = data.title;
  start.value = data.start_time.slice(0,16);
  end.value = data.end_time.slice(0,16);

  editId = id;
};

/* ================= DELETE ================= */
window.deleteEvent = async (id) => {
  if (!confirm("Termin wirklich l√∂schen?")) return;

  const { error } = await sb
    .from("events")
    .delete()
    .eq("id", id);

  if (error) {
    alert(error.message);
    return;
  }

  loadEvents();
};

/* ================= START ================= */
loadEvents();
</script>

</body>
</html>
